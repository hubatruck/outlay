(function($,DataTable){"use strict";var _buildParams=function(dt,action,onlyVisibles){var params=dt.ajax.params();params.action=action;params._token=$('meta[name="csrf-token"]').attr('content');if(onlyVisibles){params.visible_columns=_getVisibleColumns()}else{params.visible_columns=null}return params};var _getVisibleColumns=function(){var visible_columns=[];$.each(DataTable.settings[0].aoColumns,function(key,col){if(col.bVisible){visible_columns.push(col.name)}});return visible_columns};var _downloadFromUrl=function(url,params){var postUrl=url+'/export';var xhr=new XMLHttpRequest();xhr.open('POST',postUrl,true);xhr.responseType='arraybuffer';xhr.onload=function(){if(this.status===200){var filename="";var disposition=xhr.getResponseHeader('Content-Disposition');if(disposition&&disposition.indexOf('attachment')!==-1){var filenameRegex=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;var matches=filenameRegex.exec(disposition);if(matches!=null&&matches[1]){filename=matches[1].replace(/['"]/g,'')}}var type=xhr.getResponseHeader('Content-Type');var blob=new Blob([this.response],{type:type});if(typeof window.navigator.msSaveBlob!=='undefined'){window.navigator.msSaveBlob(blob,filename)}else{var URL=window.URL||window.webkitURL;var downloadUrl=URL.createObjectURL(blob);if(filename){var a=document.createElement("a");if(typeof a.download==='undefined'){window.location=downloadUrl}else{a.href=downloadUrl;a.download=filename;document.body.appendChild(a);a.click()}}else{window.location=downloadUrl}setTimeout(function(){URL.revokeObjectURL(downloadUrl)},100);}}};xhr.setRequestHeader('Content-type','application/x-www-form-urlencoded');xhr.send($.param(params))};var _buildUrl=function(dt,action){var url=dt.ajax.url()||'';var params=dt.ajax.params();params.action=action;if(url.indexOf('?')>-1){return url+'&'+$.param(params)}return url+'?'+$.param(params)};DataTable.ext.buttons.excel={className:'buttons-excel',text:function(dt){return '<i class="fa fa-file-excel-o"></i> '+dt.i18n('buttons.excel','Excel')},action:function(e,dt,button,config){window.location=_buildUrl(dt,'excel')}};DataTable.ext.buttons.postExcel={className:'buttons-excel',text:function(dt){return '<i class="fa fa-file-excel-o"></i> '+dt.i18n('buttons.excel','Excel')},action:function(e,dt,button,config){var url=dt.ajax.url()||window.location.href;var params=_buildParams(dt,'excel');_downloadFromUrl(url,params)}};DataTable.ext.buttons.postExcelVisibleColumns={className:'buttons-excel',text:function(dt){return '<i class="fa fa-file-excel-o"></i> '+dt.i18n('buttons.excel','Excel (only visible columns)')},action:function(e,dt,button,config){var url=dt.ajax.url()||window.location.href;var params=_buildParams(dt,'excel',true);_downloadFromUrl(url,params)}};DataTable.ext.buttons.export={extend:'collection',className:'buttons-export',text:function(dt){return '<i class="fa fa-download"></i> '+dt.i18n('buttons.export','Export')+'&nbsp;<span class="caret"/>'},buttons:['csv','excel','pdf']};DataTable.ext.buttons.csv={className:'buttons-csv',text:function(dt){return '<i class="fa fa-file-excel-o"></i> '+dt.i18n('buttons.csv','CSV')},action:function(e,dt,button,config){window.location=_buildUrl(dt,'csv')}};DataTable.ext.buttons.postCsvVisibleColumns={className:'buttons-csv',text:function(dt){return '<i class="fa fa-file-excel-o"></i> '+dt.i18n('buttons.csv','CSV (only visible columns)')},action:function(e,dt,button,config){var url=dt.ajax.url()||window.location.href;var params=_buildParams(dt,'csv',true);_downloadFromUrl(url,params)}};DataTable.ext.buttons.postCsv={className:'buttons-csv',text:function(dt){return '<i class="fa fa-file-excel-o"></i> '+dt.i18n('buttons.csv','CSV')},action:function(e,dt,button,config){var url=dt.ajax.url()||window.location.href;var params=_buildParams(dt,'csv');_downloadFromUrl(url,params)}};DataTable.ext.buttons.pdf={className:'buttons-pdf',text:function(dt){return '<i class="fa fa-file-pdf-o"></i> '+dt.i18n('buttons.pdf','PDF')},action:function(e,dt,button,config){window.location=_buildUrl(dt,'pdf')}};DataTable.ext.buttons.postPdf={className:'buttons-pdf',text:function(dt){return '<i class="fa fa-file-pdf-o"></i> '+dt.i18n('buttons.pdf','PDF')},action:function(e,dt,button,config){var url=dt.ajax.url()||window.location.href;var params=_buildParams(dt,'pdf');_downloadFromUrl(url,params)}};DataTable.ext.buttons.print={className:'buttons-print',text:function(dt){return '<i class="fa fa-print"></i> '+dt.i18n('buttons.print','Print')},action:function(e,dt,button,config){window.location=_buildUrl(dt,'print')}};DataTable.ext.buttons.reset={className:'buttons-reset',text:function(dt){return '<i class="fa fa-undo"></i> '+dt.i18n('buttons.reset','Reset')},action:function(e,dt,button,config){dt.search('');dt.columns().search('');dt.draw()}};DataTable.ext.buttons.reload={className:'buttons-reload',text:function(dt){return '<i class="fa fa-refresh"></i> '+dt.i18n('buttons.reload','Reload')},action:function(e,dt,button,config){dt.draw(false)}};DataTable.ext.buttons.create={className:'buttons-create',text:function(dt){return '<i class="fa fa-plus"></i> '+dt.i18n('buttons.create','Create')},action:function(e,dt,button,config){window.location=window.location.href.replace(/\/+$/,"")+'/create'}};DataTable.ext.buttons.colvis=function(b,a){return{extend:"collection",text:function(dt){return '<i class="fa fa-eye"></i> '+dt.i18n('buttons.colvis','Column visibility')},className:"buttons-colvis",buttons:[{extend:"columnsToggle",columns:a.columns,columnText:a.columnText}]}};DataTable.ext.buttons.columnsToggle=function(b,a){return b.columns(a.columns).indexes().map(function(c){return{extend:"columnToggle",columns:c,columnText:a.columnText}}).toArray()};DataTable.ext.buttons.columnToggle=function(b,a){return{extend:"columnVisibility",columns:a.columns,columnText:a.columnText}};DataTable.ext.buttons.columnVisibility=function(b,a,l){return{columns:l,text:function(b,a,c){return c._columnText(b,c)},className:"buttons-columnVisibility",action:function(b,a,c,d){b=a.columns(d.columns);a=b.visible();b.visible(d.visibility!==l?d.visibility:!(a.length&&a[0]))},init:function(b,a,c){var d=this;a.attr("data-cv-idx",c.columns);b.on("column-visibility.dt"+c.namespace,function(h,k){k.bDestroying||k.nTable!==b.settings()[0].nTable||d.active(b.column(c.columns).visible())}).on("column-reorder.dt"+c.namespace,function(h,k,m){1===b.columns(c.columns).count()&&(d.text(c._columnText(b,c)),d.active(b.column(c.columns).visible()))});this.active(b.column(c.columns).visible())},destroy:function(b,a,c){b.off("column-visibility.dt"+c.namespace).off("column-reorder.dt"+c.namespace)},_columnText:function(b,a){var c=b.column(a.columns).index(),d=b.settings()[0].aoColumns[c].sTitle;d||(d=b.column(c).header().innerHTML);d=d.replace(/\n/g," ").replace(/<br\s*\/?>/gi," ").replace(/<select(.*?)<\/select>/g,"").replace(/<!\-\-.*?\-\->/g,"").replace(/<.*?>/g,"").replace(/^\s+|\s+$/g,"");return a.columnText?a.columnText(b,c,d):d}}};DataTable.ext.buttons.colvisRestore=function(b,a,c){return{text:function(dt){return dt.i18n("buttons.colvisRestore","Restore visibility")},init:function(b,a,c){c._visOriginal=b.columns().indexes().map(function(d){return b.column(d).visible()}).toArray()},action:function(b,a,c,d){a.columns().every(function(h){h=a.colReorder&&a.colReorder.transpose?a.colReorder.transpose(h,"toOriginal"):h;this.visible(d._visOriginal[h])})}}};if(typeof DataTable.ext.buttons.copyHtml5!=='undefined'){$.extend(DataTable.ext.buttons.copyHtml5,{text:function(dt){return '<i class="fa fa-copy"></i> '+dt.i18n('buttons.copy','Copy')}})}})(jQuery,jQuery.fn.dataTable);
